<?xml version="1.0" encoding="utf-8" ?>

<config:template-call
	xmlns:config="http://www.top-logic.com/ns/config/6.0"
	template="com.top_logic.model.search/create/genericCreateDialog.template.xml"
>
	<arguments>
		<forms>
			<form type="tl.ai.demo.imageclassification:Invoice">
				<formDefinition>
					<field
						attribute="data"
						fullQualifiedName="tl.ai.demo.imageclassification:Invoice#data"
						type="tl.core:Binary"
					/>
				</formDefinition>
			</form>
		</forms>
		<title title="class.com.top_logic.model.search.providers.I18NConstants.CREATE_OBJECT_DEFAULT_LABEL"/>
		<open-handler id="addNewElement"
			config:interface="com.top_logic.layout.editor.config.CreateDialogOpenHandlerConfig"
			image="theme:ICONS_ADD_BUTTON"
			resourceKey="class.com.top_logic.model.search.providers.I18NConstants.CREATE_OBJECT_DEFAULT_LABEL"
		/>
		<typeOptions type="tl.ai.demo.imageclassification:Invoice"/>
		<create-handler id="createNewElement">
			<linkOperation><![CDATA[container -> invoice -> {
    data = $invoice.get(`tl.ai.demo.imageclassification:Invoice#data`);
    result = aiChat(
        [{
            "role": "system", 
            "content": "Take the image provided by the user and return a JSON object with the properties 'description', 'date', 'amount' filled with the values from the given invoice. Use image recognition to analyze the document, if no text data is available. Generate text in language {0}.".fill(
                currentUser().get(`tl.accounts:Person#locale`))
        }, 
        {
            "role": "user", 
            "content": $data
        }],
        responseFormat: {
            "name": "classification", 
            "schema": {
                "$schema": "https://json-schema.org/draft/2020-12/schema",
                "type": "object",
                "additionalProperties": false,
                "properties": {
                    "description": {
                        "type": "string",
                        "description": "What has been bought?"
                    },
                    "value": {
                        "type": "number",
                        "description": "How much was payed?"
                    },
                    "date": {
                        "type": "string",
                        "format": "date",
                        "description": "When was the purchase made, use dd.MM.yyyy as date format."
                    }
                }
            }
        }
    )
    .parseJson()
    ["properties"];

    $invoice.set(`tl.ai.demo.imageclassification:Invoice#description`, $result["description"]);
    $invoice.set(`tl.ai.demo.imageclassification:Invoice#amount`, $result["value"]);
    $invoice.set(`tl.ai.demo.imageclassification:Invoice#date`, dateFormat("dd.MM.yyyy").parse($result["date"]));
}]]></linkOperation>
		</create-handler>
	</arguments>
</config:template-call>